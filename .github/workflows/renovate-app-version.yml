name: Update app version in Renovate Branches

on:
  push:
    branches: [ 'renovate/*' ]
  workflow_dispatch:

jobs:
  update-app-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0  # Get full history for proper diff

      - name: Configure git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y yq

      - name: Detect changed files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # For push events, compare with the previous commit
            files=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          else
            # For workflow_dispatch, compare with main
            files=$(git diff origin/main --name-only)
          fi
          
          # Filter for docker-compose.yml files
          docker_files=$(echo "$files" | grep "docker-compose.yml" | sort -u || true)
          echo "docker_files<<EOF" >> $GITHUB_OUTPUT
          echo "$docker_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Process app versions
        if: steps.changes.outputs.docker_files != ''
        id: process
        run: |
          chmod +x .github/workflows/renovate-app-version.sh
          
          echo "${{ steps.changes.outputs.docker_files }}" | while read docker_file; do
            if [ -z "$docker_file" ]; then
              continue
            fi
            
            app_name=$(echo "$docker_file" | cut -d'/' -f 2)
            old_version=$(echo "$docker_file" | cut -d'/' -f 3)
            
            echo "Processing: $app_name ($old_version)"
            .github/workflows/renovate-app-version.sh "$app_name" "$old_version"
          done
          
          # Check if there are changes to commit
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.process.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "chore: update app versions from Renovate [skip ci]" \
                    --author="github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          git push

      - name: Create or update pull request
        if: steps.process.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const title = `chore: update app versions from Renovate`;
            const body = `Automated app version updates from Renovate.\n\nBranch: \`${branch}\``;
            
            // Check if PR already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (existingPRs.data.length > 0) {
              console.log(`PR #${existingPRs.data[0].number} already exists, skipping creation`);
            } else {
              const newPR = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                head: branch,
                base: 'main'
              });
              console.log(`Created PR #${newPR.data.number}`);
            }

      - name: Auto-merge pull request
        if: steps.process.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            
            // Wait a moment for PR to be created
            await new Promise(r => setTimeout(r, 2000));
            
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: 'chore: update app versions from Renovate',
                  commit_message: `Automated app version updates.\n\nBranch: ${branch}`
                });
                console.log(`Successfully merged PR #${pr.number}`);
              } catch (error) {
                console.log(`Cannot merge PR #${pr.number} yet: ${error.message}`);
                console.log('PR will be available for manual review');
              }
            }
